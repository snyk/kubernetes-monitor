sudo: false
dist: xenial
services: docker
language: node_js
cache:
  directories:
    - node_modules
notifications:
  email: false
  slack:
    on_failure: always
    on_success: never
    on_pull_requests: false
node_js:
  - '10'
before_install:
  - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc
install:
  - npm install
jobs:
  include:
######################## PR TO STAGING ########################
    # PR tests for staging branch
    - stage: Test-PR-staging
      if: branch = staging AND type = pull_request
      script: npm run test
      name: kubernetes-monitor PR tests
######################## MERGE TO STAGING ########################
    - stage: test-and-build
      if: branch = staging AND type = push
      script: npm run lint &&
              npm run build &&
              npm run test:unit &&
              docker login --username ${DOCKERHUB_USER} --password ${DOCKERHUB_PASSWORD} &&
              npx semantic-release &&
              NEW_VERSION=`cat ./package.json | jq -r '.version'` &&
              IMAGE_NAME_CANDIDATE="snyk/kubernetes-monitor:${NEW_VERSION}-candidate" &&
              ./scripts/build-image.sh ${IMAGE_NAME_CANDIDATE} &&
              docker push ${IMAGE_NAME_CANDIDATE} &&
              ./scripts/slack-notify-push.sh ${IMAGE_NAME_CANDIDATE} &&
              KUBERNETES_MONITOR_IMAGE_NAME_AND_TAG=${IMAGE_NAME_CANDIDATE} npm run test:integration &&
              IMAGE_NAME_APPROVED="snyk/kubernetes-monitor:${NEW_VERSION}-approved" &&
              docker tag ${IMAGE_NAME_CANDIDATE} ${IMAGE_NAME_APPROVED} &&
              docker push ${IMAGE_NAME_APPROVED} &&
              ./scripts/slack-notify-push.sh ${IMAGE_NAME_APPROVED}
      name: Test and Build
######################## PR TO MASTER ########################
    - stage: pre-publish
      if: branch = master AND type = pull_request AND head_branch = staging
      script: ./scripts/slack-notify-pr.sh
      name: pre-publish notification
######################## MERGE TO MASTER ########################
    - stage: Publish
      if: branch = master AND type = push
      script: docker login --username ${DOCKERHUB_USER} --password ${DOCKERHUB_PASSWORD} &&
              docker pull snyk/kubernetes-monitor:test-approved &&
              docker tag snyk/kubernetes-monitor:test-approved snyk/kubernetes-monitor:latest &&
              docker push snyk/kubernetes-monitor:latest &&
              ./scripts/slack-notify-push.sh latest
      name: publish the kubernetes-monitor (npm, container, helm)
######################## TEMPORARY EXPERIMENTS ########################
    - stage: test-and-build
      if: branch = ci_experiments AND type = push
      script: npm run lint &&
              npm run build &&
              npm run test:unit &&
              docker login --username ${DOCKERHUB_USER} --password ${DOCKERHUB_PASSWORD} &&
              npx semantic-release --branch ci_experiments &&
              NEW_VERSION=`cat ./package.json | jq -r '.version'` &&
              IMAGE_NAME_CANDIDATE="snyk/kubernetes-monitor:${NEW_VERSION}-candidate" &&
              ./scripts/build-image.sh ${IMAGE_NAME_CANDIDATE} &&
              docker push ${IMAGE_NAME_CANDIDATE} &&
              ./scripts/slack-notify-push.sh ${IMAGE_NAME_CANDIDATE} &&
              KUBERNETES_MONITOR_IMAGE_NAME_AND_TAG=${IMAGE_NAME_CANDIDATE} npm run test:integration &&
              IMAGE_NAME_APPROVED="snyk/kubernetes-monitor:${NEW_VERSION}-approved" &&
              docker tag ${IMAGE_NAME_CANDIDATE} ${IMAGE_NAME_APPROVED} &&
              docker push ${IMAGE_NAME_APPROVED} &&
              ./scripts/slack-notify-push.sh ${IMAGE_NAME_APPROVED}
      name: Test and Build
branches:
  only:
   - master
   - staging
   - ci_experiments
